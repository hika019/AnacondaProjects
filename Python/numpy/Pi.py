import math
import time
from decimal import *

import numpy as np


#文字数1002
PI_1000 = "3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989"


def get_pi(prec, verbose=False):
    '''
    小数点以下の桁数がprecの円周率を文字列で返す
    '''
    prec = prec+1+1 #精度 "3."の部分があるので、1つ精度を増やして、さらにもう1けたないと丸目の関係でずれることがあるので、さらに1追加
    N = 2*math.ceil(math.log2(prec)) #繰り返し回数 wikipediaによると、log2(prec)程度でいいらしいので、念の為、その２倍程度にする

    getcontext().prec = prec 

    a = Decimal(1.0)
    b = Decimal(1.0) / Decimal(2.0).sqrt()
    t = Decimal(0.25)
    p = Decimal(1.0)


    start_time = time.clock() 

    # N回の試行を開始
    for _ in range(1, N):
        a_next = (a + b)/Decimal(2)
        b_next = (a*b).sqrt()
        t_next = t - p * (a - a_next)**2
        p_next = Decimal(2)*p

        a = a_next
        b = b_next
        t = t_next
        p = p_next
        pi = (a + b)**2 / (Decimal(4)*t)
        print(pi)

    #円周率を計算
    print('##################################')
    pi = (a + b)**2 / (Decimal(4)*t)
    print(pi)
    #実行時間を計算
    elapsed = time.clock()  - start_time

    #　実行結果を表示する
    if verbose:
        print("精度：",prec)
        print("円周率:", pi)
        print("実行時間:%f" % (elapsed))

    return str(pi)[0:prec]

pi = get_pi(100, verbose=True)
print(pi)
